#!/usr/sbin/nft -f

flush ruleset

table inet filter {
    chain input {
        type filter hook input priority 0; policy accept;
    }

    chain forward {
        type filter hook forward priority 0; policy accept;

        # Accept forwarding for established connections
        ct state related,established accept

        # Explicitly drop traffic trying to cross between vmbr1 and vmbr2 subnets
        ip saddr 192.168.1.0/24 ip daddr 192.168.2.0/24 drop
        ip saddr 192.168.2.0/24 ip daddr 192.168.1.0/24 drop

        # Accept forwarding within the same bridge
        iifname "vmbr1" oifname "vmbr1" accept
        iifname "vmbr2" oifname "vmbr2" accept
    }

    chain output {
        type filter hook output priority 0; policy accept;
    }
}

table ip nat {
    chain prerouting {
        type nat hook prerouting priority dstnat; policy accept;
    }

    chain postrouting {
        type nat hook postrouting priority srcnat; policy accept;

        # Masquerade traffic going out through vmbr0, excluding intra-bridge traffic
        # This simplification assumes any non-local traffic uses vmbr0
        ip saddr 192.168.1.0/24 oif "vmbr0" masquerade
        ip saddr 192.168.2.0/24 oif "vmbr0" masquerade
    }
}

